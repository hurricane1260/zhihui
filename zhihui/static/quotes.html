<!DOCTYPE html>
<html>
<head>
    <!-- Bootstrap -->
    <link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <title></title>
    <!-- jQuery -->
    <script src="/static/js/jquery-1.7.2.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/static/js/bootstrap.min.js"></script>
    <!-- HighStock -->
    <script src="/static/js/highstock.js"></script>


</head>
<body>
<div class="box-content">

     <script type="text/javascript">
        $(function () {
            $.getJSON('http://127.0.0.1:8080/quotes', function (data) {
                // Create the chart
                var chartdata = []
                var flagslinedata =  []
                var flagsdataBuyOpen = []
                var flagsdataBuyClose = []
                var flagsdataSellOpen = []
                var flagsdataSellClose = []

                function filldata(){

                    var openPrice = 0;
                    var openTickCount = 0;
                    var tempDates = []
                    var skipline = false
                    for(var i=0; i<data.length; i++){

                        var dateStr = data[i].time.toString()
                        var year = dateStr.slice(0,4)
                        var month = dateStr.slice(4,6)
                        var day = dateStr.slice(6,8)

                        var temp = [
                            Date.UTC(year,month,day),
                            data[i].open,
                            data[i].high,
                            data[i].low,
                            data[i].close]

                        var order = data[i].order

                        if(order == 1){
                            openTickCount++
                            openPrice = data[i].low
                            tempDates.push(Date.UTC(year, month, day))
                            var flag ={
                            x : Date.UTC(year, month, day),
                            y : data[i].low,
                            title : 'BO',
                            text : 'buy order open'
                            }
                            flagsdataBuyOpen.push(flag)
                        }else if(order == 2){
                            openTickCount++
                            tempDates.push(Date.UTC(year, month, day))
                            var flag ={
                            x : Date.UTC(year, month, day),
                            y : data[i].high,
                            title : 'BC',
                            text : 'buy order close'
                            }
                            flagsdataBuyClose.push(flag)
                            var price = openPrice;
                            var nowprice = data[i].high
                            for(var j = 0; j< openTickCount;j++){
                                price = openPrice + (nowprice - openPrice)*j/(openTickCount-1)
                                var templine = [
                                    tempDates[j],
                                    price,
                                    price,
                                    price,
                                    price]
                                flagslinedata.push(templine)
                            }
                            openTickCount = 0;
                            openPrice = 0;
                            skipline = true
                            tempDates = []
                        }else if(order == 3){
                            openTickCount++
                            openPrice = data[i].high
                            tempDates.push(Date.UTC(year, month, day))

                            var flag ={
                            x : Date.UTC(year, month, day),
                            y : data[i].high,
                            title : 'SO',
                            text : 'sell order open'
                            }
                            flagsdataSellOpen.push(flag)
                        }else if(order == 4){
                            openTickCount++
                            tempDates.push(Date.UTC(year, month, day))
                            var flag ={
                            x : Date.UTC(year, month, day),
                            y : data[i].low,
                            title : 'SC',
                            text : 'sell order close'
                            }
                            flagsdataSellClose.push(flag)
                            var price = openPrice;
                            var nowprice = data[i].low
                            for(var j = 0; j < openTickCount;j++){
                                price = openPrice + (nowprice - openPrice)*j/(openTickCount-1)
                                var templine = [
                                    tempDates[j],
                                    price,
                                    price,
                                    price,
                                    price]
                                flagslinedata.push(templine)
                            }
                            openTickCount = 0
                            openPrice = 0;
                            skipline = true
                            tempDates = []
                        }
                        if(openTickCount == 0 && !skipline){
                            var price = null
                            var temp2 = [
                                    Date.UTC(year, month, day),
                                    price,
                                    price,
                                    price,
                                    price]
                            flagslinedata.push(temp2)
                        }
                        skipline = false
                        chartdata.push(temp)

                    }
                }

                filldata()
                //console.log(chartdata)
                $('#container').highcharts('StockChart', {
                    rangeSelector: {
                        selected: 1
                    },

                    title: {
                        text: 'EURUSD Price'
                    },

                    series: [
                        {
                            name: 'EURUSD',
                            type: 'candlestick',
                            data: chartdata
                        },
                        {
                            name : 'Result',
                            data : flagslinedata,
                            tooltip: {
                                valueDecimals: 2
                            }
                        },
                        {
                            type : 'flags',
                            data : flagsdataBuyOpen,
                            onSeries : 'dataseries',
                            shape : 'circlepin',
                            color : '#5F86B3',
				            fillColor : '#00ff00',
				            style : {// text style
					            color : 'white'
				            },
                            width : 16
                        },
                        {
                            type : 'flags',
                            data : flagsdataBuyClose,
                            onSeries : 'dataseries',
                            shape : 'squarepin',
                            color : '#5F86B3',
				            fillColor : '#00ff00',
				            style : {// text style
					            color : 'white'
				            },
                            width : 16
                        },
                        {
                            type : 'flags',
                            data : flagsdataSellOpen,
                            onSeries : 'dataseries',
                            shape : 'circlepin',
                            color : '#5F86B3',
				            fillColor : '#ff0000',
				            style : {// text style
					            color : 'white'
				            },
                            width : 16
                        },
                        {
                            type : 'flags',
                            data : flagsdataSellClose,
                            onSeries : 'dataseries',
                            shape : 'squarepin',
                            color : '#5F86B3',
				            fillColor : '#ff0000',
				            style : {// text style
					            color : 'white'
				            },
                            width : 16
                        }

                    ]
                });
            });
        });
    </script>
    <div id="container" style="height: 500px; min-width: 500px"></div>

</div>


</body>
</html>