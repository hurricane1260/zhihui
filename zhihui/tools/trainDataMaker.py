__author__ = 'billzhou'
# this tool is used for crate train data from input quote data

from zhihui.web.extention.routing import route
from ultrafinance.dam.sqlDAM import SqlDAM, QuoteSql
import numpy as np
import pylab as pl
from sklearn import svm
from sklearn import linear_model
from sklearn import tree
import pandas as pd
from sklearn import datasets
from datetime import datetime
from ultrafinance.pyTaLib.indicator import Stoch
import time
from talib import abstract

# def svmtest():
#     clf = svm.SVC(kernel='linear')
#     fractalsList = getFractalsList()
#     fractalsFiltered, target = getFilteredFractalsList(fractalsList)
#     nft = np.array(fractalsFiltered)
#     ntarget = np.array(target)
#     clf.fit(nft, ntarget)
#     print nft
#     print ntarget
#     print clf.predict(nft)

def tablibtest():
    quotes = getSourceData()
    inputs = []
    for quote in quotes:
        inputs.append(quote.close)
    tainputs = np.array(inputs)

    myinput = {
    'open': tainputs,
    'high': tainputs,
    'low': tainputs,
    'close': tainputs,
    'volume': np.random.random(100)
    }
    stoch = Stoch(30)
    for i in range(0,100):
        print stoch(tainputs[i])


def getSourceData():
    dam = SqlDAM()
    dam.setup({'db': 'sqlite:///../../zhihui/data/ftest.sqlite'})
    dam.setSymbol('EURUSD')
    _quotes = dam.readQuotes(20000101, 20131231)
    return _quotes


selectFractalData =[1382630400000,1378310400000,1376928000000,1373299200000,1371484800000,1371052800000,1369670400000,1369152000000,1368720000000,1367337600000,1367942400000,1364313600000,1364313600000,1364832000000,1359648000000,1357142400000,1357660800000,1359648000000,1357660800000,1357142400000,1354809600000,1352736000000,1350403200000,1349798400000,1347552000000,1343059200000,1346688000000,1340121600000,1340899200000,1338393600000,1335715200000,1332691200000,1333036800000,1331654400000,1330012800000,1331136000000,1329235200000,1328716800000,1326643200000,1325779200000,1319644800000,1317571200000,1317225600000,1316016000000,1314547200000,1311609600000,1312387200000,1309708800000,1310400000000,1310400000000,1308844800000,1307376000000,1306080000000,1306080000000,1304265600000,1303056000000,1300982400000,1297699200000,1294329600000,1293724800000,1291046400000,1291046400000,1288800000000,1288800000000,1286985600000,1283788800000,1281024000000,1277740800000,1279641600000,1275840000000,1271174400000,1272556800000,1269446400000,1263139200000]
selectFractalData2 = [1128355200000, 11128528000000, 21129824000000, 31130342400000, 41130860800000, 51132070400000, 61134662400000, 71135094400000, 81135612800000, 91136476800000, 1137600000000, 11137945600000, 11138636800000, 11139500800000, 11140969600000, 11141228800000, 11142524800000, 11143043200000, 11143475200000, 11144166400000, 21144771200000, 21147363200000, 1149177600000, 1150128000000, 1150992000000, 1152201600000, 1153152000000, 1154620800000, 1155484800000, 1156089600000, 1156435200000, 1157299200000, 1157644800000, 1159718400000, 1160668800000, 1165161600000, 1165852800000, 1167667200000, 1168444800000, 1173369600000, 1174406400000, 1176048000000, 1177603200000, 1179158400000, 1180972800000, 1181577600000, 1184860800000, 1185465600000, 1186502400000, 1187625600000, 1192982400000, 1196006400000, 1198080000000, 1200240000000, 1200844800000, 1202313600000, 1205683200000, 1208793600000, 1210780800000, 1211299200000, 1222012800000, 1228406400000, 1229443200000, 1236182400000, 1237392000000, 1240156800000, 1242316800000, 1243872000000, 1251734400000, 1253548800000, 1254326400000, 1256140800000, 1259078400000, 1261411200000, 1260374400000, 1264348800000, 1272556800000, 1273420800000, 1283788800000, 1288800000000, 1291046400000, 1291305600000, 1293724800000, 1294329600000, 1295193600000, 1303056000000, 1304265600000, 1308844800000, 1309708800000, 1310400000000, 1311609600000, 1314547200000, 1317571200000, 1319644800000, 1320940800000, 1326643200000, 1327593600000, 1330012800000, 1331654400000, 1335715200000, 1340899200000, 1346688000000, 1347552000000, 1351526400000, 1352736000000, 1353945600000, 1357660800000, 1359648000000, 1364832000000, 1367942400000, 1369670400000, 1371484800000, 1373299200000, 1377532800000, 1378310400000, 1381766400000, 1382630400000, 1383840000000]

class FractalSelectManager(object):

    __filteredDict = {}

    def __init__(self, fractalTimeKey = selectFractalData):
        self.__selectData = fractalTimeKey
        for data in self.__selectData:
            gmtime = time.gmtime(data/1000+24*60*60)
            timestr = '%4d%02d%02d' % (gmtime.tm_year, gmtime.tm_mon, gmtime.tm_mday)
            key = int(timestr)
            self.__filteredDict[key] = data

    def isSelected(self, time):
        if time in self.__filteredDict:
            return True
        else:
            return False


if __name__ == "__main__":
    # buildTrainData()
    # svmtest()
    # processSelectData()
    tablibtest()
